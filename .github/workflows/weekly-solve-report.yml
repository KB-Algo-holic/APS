name: Weekly Solve Report

on:
  schedule:
    - cron: '59 14 * * 0'  # Îß§Ï£º ÏùºÏöîÏùº 23:59 (KST Í∏∞Ï§Ä)
  workflow_dispatch:

jobs:
  weekly-solve-report:
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Count solve commits for this week
        id: solve
        shell: bash
        run: |
          set -e

          BASE_DATE="2025-06-23"
          BASE_WEEK=4

          NOW_TS=$(date +%s)
          BASE_TS=$(date -d "$BASE_DATE" +%s)

          DAYS_SINCE_BASE=$(( (NOW_TS - BASE_TS) / 86400 ))
          WEEKS_SINCE_BASE=$(( DAYS_SINCE_BASE / 7 ))
          CURRENT_WEEK=$(( BASE_WEEK + WEEKS_SINCE_BASE ))

          declare -A stats

          # Î°úÍ∑∏Î•º ÌååÏùºÎ°ú Ï†ÄÏû•Ìïú ÌõÑ ÏùΩÍ∏∞
          git fetch origin main --depth=100
          git log origin/main --pretty='%H %an|%ad|%s' --date=iso > all_logs.txt

          while IFS="|" read -r author date_subject; do
            name=$(echo "$author" | cut -d' ' -f2-)  # Ïª§Î∞ã Ìï¥Ïãú Ïù¥ÌõÑ Ïù¥Î¶Ñ
            commit_date=$(echo "$date_subject" | cut -d'|' -f1)
            commit_msg=$(echo "$date_subject" | cut -d'|' -f2-)

            if echo "$commit_msg" | grep -iq "solve"; then
              COMMIT_TS=$(date -d "$commit_date" +%s)
              DAYS=$(( (COMMIT_TS - BASE_TS) / 86400 ))
              WEEK_OF_COMMIT=$(( BASE_WEEK + (DAYS / 7) ))

              if [ "$WEEK_OF_COMMIT" -eq "$CURRENT_WEEK" ]; then
                stats["$name"]=$(( ${stats["$name"]:-0} + 1 ))
              fi
            fi
          done < all_logs.txt

          {
            echo "üìä ${CURRENT_WEEK}Ï£ºÏ∞® Solve Ïª§Î∞ã ÌÜµÍ≥Ñ"
            echo ""
            echo '```'  # ÏΩîÎìú Î∏îÎ°ù ÏãúÏûë
            printf "%-10s | %s\n" "Ïù¥Î¶Ñ" "Ïª§Î∞ã Ïàò"
            echo "-------------------------"
            for name in "${!stats[@]}"; do
              printf "%-10s | %d\n" "$name" "${stats[$name]}"
            done | sort -t '|' -k2 -nr
            echo '```'  # ÏΩîÎìú Î∏îÎ°ù ÎÅù
          } > message.txt

          echo 'CONTENT<<EOF' >> $GITHUB_ENV
          cat message.txt >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

          echo "==== üêõ DEBUG START ===="
          cat message.txt
          echo "==== üêõ DEBUG END ===="

      - name: Send Discord notification
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$(jq -n --arg content "$CONTENT" --arg username "Algo-Holic Bot" \
                 '{content: $content, username: $username}')" \
               "${{ secrets.DISCORD_WEBHOOK_URL }}"
