name: Weekly Solve Report

on:
  schedule:
    - cron: '59 14 * * 0'  # ë§¤ì£¼ ì¼ìš”ì¼ 23:59 (KST â†’ UTC ê¸°ì¤€ 14:59)
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  weekly-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Count solve commits for this week
        id: solve-stats
        run: |
          # ê¸°ì¤€ ì£¼ì°¨ ì •ë³´: 2025-06-24ì´ 4ì£¼ì°¨
          base_date="2025-06-24"
          base_week=4

          now=$(date +%s)
          base_ts=$(date -d "$base_date" +%s)

          # ì´ë²ˆ ì£¼ì°¨ ê³„ì‚°
          days_since_base=$(( (now - base_ts) / 86400 ))
          weeks_since_base=$(( days_since_base / 7 ))
          current_week=$(( base_week + weeks_since_base ))

          declare -A stats

          # solve ì»¤ë°‹ ìˆ˜ ì§‘ê³„ (ìž‘ì„±ìžë³„, ì´ë²ˆ ì£¼ì°¨ë§Œ)
          git log main --grep="solve" --pretty='%an|%ad' --date=iso | while IFS="|" read -r name date; do
              ts=$(date -d "$date" +%s)
              days_since_base=$(( (ts - base_ts) / 86400 ))
              week_of_commit=$(( base_week + (days_since_base / 7) ))

              if [ "$week_of_commit" -eq "$current_week" ]; then
                  stats["$name"]=$(( stats["$name"] + 1 ))
              fi
          done

          # ê²°ê³¼ íŒŒì¼ ìƒì„±
          echo "" > result.txt
          echo "ðŸ“Š ì´ë²ˆ ì£¼ Solve ì»¤ë°‹ ëž­í‚¹ (${current_week}ì£¼ì°¨)" >> result.txt
          echo "" >> result.txt
          echo "| ì´ë¦„     | ì»¤ë°‹ ìˆ˜ |" >> result.txt
          echo "|----------|---------|" >> result.txt

          for name in "${!stats[@]}"; do
              printf "| %-8s | %-7d |\n" "$name" "${stats[$name]}"
          done | sort -t '|' -k3 -nr >> result.txt

          echo 'content<<EOF' >> $GITHUB_OUTPUT
          echo '```\n'"$(cat result.txt)"'\n```' >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Send Discord notification
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "content": "'"${{ steps.solve-stats.outputs.content }}"'",
                 "username": "Algo-Holic Bot"
               }' \
               "${{ secrets.DISCORD_WEBHOOK_URL }}"
