name: Weekly Solve Report

on:
  schedule:
    - cron: '59 14 * * 0'  # 매주 일요일 23:59 (KST → UTC 기준 14:59)
  workflow_dispatch:  # 수동 실행도 가능

jobs:
  weekly-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Count solve commits for this week
        id: solve-stats
        run: |
          # 기준 주차 정보: 2025-06-24이 4주차
          base_date="2025-06-24"
          base_week=4

          now=$(date +%s)
          base_ts=$(date -d "$base_date" +%s)

          # 이번 주차 계산
          days_since_base=$(( (now - base_ts) / 86400 ))
          weeks_since_base=$(( days_since_base / 7 ))
          current_week=$(( base_week + weeks_since_base ))

          declare -A stats

          # solve 커밋 수 집계 (작성자별, 이번 주차만)
          git log main --grep="solve" --pretty='%an|%ad' --date=iso | while IFS="|" read -r name date; do
              ts=$(date -d "$date" +%s)
              days_since_base=$(( (ts - base_ts) / 86400 ))
              week_of_commit=$(( base_week + (days_since_base / 7) ))

              if [ "$week_of_commit" -eq "$current_week" ]; then
                  stats["$name"]=$(( stats["$name"] + 1 ))
              fi
          done

          # 결과 파일 생성
          echo "" > result.txt
          echo "📊 이번 주 Solve 커밋 랭킹 (${current_week}주차)" >> result.txt
          echo "" >> result.txt
          echo "| 이름     | 커밋 수 |" >> result.txt
          echo "|----------|---------|" >> result.txt

          for name in "${!stats[@]}"; do
              printf "| %-8s | %-7d |\n" "$name" "${stats[$name]}"
          done | sort -t '|' -k3 -nr >> result.txt

          echo 'content<<EOF' >> $GITHUB_OUTPUT
          echo '```\n'"$(cat result.txt)"'\n```' >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Send Discord notification
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "content": "'"${{ steps.solve-stats.outputs.content }}"'",
                 "username": "Algo-Holic Bot"
               }' \
               "${{ secrets.DISCORD_WEBHOOK_URL }}"
